language: cpp

dist: trusty
sudo: false

cache:
  directories:
    - $HOME/ltsmin-deps
#    - $HOME/.cabal

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test # for gcc-7
    packages:
      - asciidoc
      - dejagnu
      - doxygen
      - g++-7
      - gcc-7
      - libboost-dev
      - libhwloc-dev
      - libgmp-dev
      - liblzma-dev
      - libnuma-dev
      - libpopt-dev
      - libz-dev
      - xmlto

stage: cache warmup

install: travis/install-$TRAVIS_OS_NAME.sh

jobs:
  include:
    - compiler: clang
      os: osx
      script: skip
    - compiler: gcc
      os: linux
      script: skip
    - os: osx
      before_script:
        - travis/install-DiVinE.sh
        - travis/install-ProB-osx.sh
      script: . travis/test-1.sh
      stage: test
    - os: linux
      before_script:
        - travis/install-DiVinE.sh
        - travis/install-ProB-linux.sh
      script: . travis/test-1.sh
      stage: test
    - os: osx
      script: . travis/test-2.sh
      stage: test
    - os: linux
      before_script:
      script: . travis/test-2.sh
      stage: test
    - compiler: gcc
      os: linux
      script:
        - . travis/build-source.sh
        - . travis/build-web.sh
      deploy:
        - provider: releases
          # define $GITHUB_TOKEN in Travis CI build environment.
          api_key: $GITHUB_TOKEN
          file:
            - "ltsmin-$TRAVIS_TAG-source.tgz"
          skip_cleanup: true
          on:
            tags: true
        - provider: pages
          # define $GITHUB_TOKEN in Travis CI build environment.
          github_token: $GITHUB_TOKEN
          local_dir: www/_site
          skip_cleanup: true
          on:
            tags: true
            condition: "x$TRAVIS_TAG = xv$LTSMIN_VERSION"
      stage: deploy
    - compiler: gcc
      os: linux
      script:
        - . travis/build-release-linux.sh
      deploy:
        - provider: releases
          # define $GITHUB_TOKEN in Travis CI build environment.
          api_key: $GITHUB_TOKEN
          file:
            - "/tmp/$LTSMIN_DISTNAME.tgz"
          skip_cleanup: true
          on:
            tags: true
      stage: deploy
    - compiler: clang
      os: osx
      script:
        - . travis/build-release-osx.sh
      deploy:
        - provider: releases
          # define $GITHUB_TOKEN in Travis CI build environment.
          api_key: $GITHUB_TOKEN
          file:
            - "/tmp/$LTSMIN_DISTNAME.tgz"
          skip_cleanup: true
          on:
            tags: true
      stage: deploy

